= Tulip: Load Testing, Stress Testing and Performance Regression Testing
v2.1.3
:toc: left
:sectnums:
:source-highlighter: highlightjs
:stylesdir: css
:stylesheet: adoc-foundation-potion.css

[cols="1a"]
|===
|
image::tulip_logo.svg[width=128]
https://github.com/wfouche/Tulip
|===

== Introduction

https://github.com/wfouche/Tulip[Tulip] is an advanced open-source software tool, writtem in Kotlin, designed for load testing, stress testing and performance regression testing. It is a robust solution for evaluating the performance and stability of web applications under varying conditions, ensuring they can handle high traffic and stress levels efficiently. Similar to well-known tools like JMeter, Gatling and Locust, Tulip provides powerful capabilities to simulate real-world scenarios and generate comprehensive reports, helping developers identify and resolve potential bottlenecks.

Tulip is available as a runtime JAR on Maven Central. A benchmark program is consists of three parts:

. JSONC benchmark configuration file specifying benchmark scenarios
. User class that implement actions to be benchmarked
. App class that activates the Tulip runtime


[plantuml,diag00,svg]
----
@startuml
split
   -[hidden]->
   #greenyellow:benchmark_config.jsonc;
split again
   -[hidden]->
   #beige:App.class;
split again
   -[hidden]->
   #beige:User.class;
split again
   -[hidden]->
   #azure:tulip-runtime.jar;
end split
:EXECUTE;
#greenyellow:benchmark_output.json;
#cadetblue:benchmark_report.html;
@enduml
----

[source,xml]
----
<!-- https://mvnrepository.com/artifact/io.github.wfouche.tulip/tulip-runtime -->
<dependency>
    <groupId>io.github.wfouche.tulip</groupId>
    <artifactId>tulip-runtime</artifactId>
    <version>2.1.3</version>
</dependency>
----

== Quick Start Guide

[cols="1a"]
|===
|
"Seeing is believing and believing is knowing and knowing beats unknowing and the unknown."
-- Philip Roth
|===

The best and quickest way to get started with Tulip is to try out the sample benchmark program.

Prerequisites::
* OpenJDK 21 or later version is installed
* https://www.jbang.dev/[JBang] 0.121.0 or later version is installed
* [optional] Scala-cli is installed to run the Scala sample benchmark program
* Tulip has been tested and works on Linux, Windows or MacOS

Run the following command to create the Kotlin version of the sample benchmark program:

`jbang io.github.wfouche.tulip:tulip-runtime:2.1.3 Kotlin`

[NOTE]
====
The sample benchmark program is implemented in four languages:

* Java
* Groovy
* Kotlin
* Scala

For example, to generate the Java version of the benchmark program simply run command:

`jbang io.github.wfouche.tulip:tulip-runtime:2.1.3 Java`
====

Thereafter start script `./run_bench.sh` (Linux or MacOS) or `.\run_bench.cmd` (Windows).

While the benchmark program is running the `benchmark_output.json` file is incrementally updated with benchmark results, and once benchmark is finished a benchmark report is generated from the benchmark out.

The benchmark report file is called `benchmark_report.html`

//
// https://www.freepik.com/free-vector/tulip-flower-logo-gradient-colorful_41061958.htm
//
// logo designed by *Freepik*
//
// https://support.freepik.com/s/article/Attribution-How-when-and-where
//

== Sample Benchmark

=== Benchmark App

.App.kt
[source,kotlin,linenums]
----
///usr/bin/env jbang "$0" "$@" ; exit $?
//DEPS io.github.wfouche.tulip:tulip-runtime:2.1.3
//DEPS org.springframework.boot:spring-boot-starter-web:3.4.1
//DEPS org.slf4j:slf4j-api:2.0.16
//DEPS ch.qos.logback:logback-core:1.5.16
//DEPS ch.qos.logback:logback-classic:1.5.16
//SOURCES HttpUser.kt
//JAVA 21
//KOTLIN 2.0.21

import io.github.wfouche.tulip.api.TulipApi

fun main(args: Array<String>) {
    TulipApi.runTulip("benchmark_config.jsonc")
}
----

=== Benchmark User Class

.HttpUser.kt
[source,kotlin,linenums]
----
import io.github.wfouche.tulip.api.*
import java.util.concurrent.ThreadLocalRandom
import org.springframework.web.client.RestClient
import org.springframework.web.client.RestClientException
import org.springframework.http.client.SimpleClientHttpRequestFactory
import org.slf4j.Logger
import org.slf4j.LoggerFactory

class HttpUser(userId: Int, threadId: Int) : TulipUser(userId, threadId) {

    // Action 0
    override fun onStart(): Boolean {
        // Initialize the shared RestClient object only once
        if (userId == 0) {
            logger.info("Kotlin")
            logger.info("Initializing static data")
            val connectTimeout = getUserParamValue("connectTimeoutMillis").toInt()
            val readTimeout = getUserParamValue("readTimeoutMillis").toInt()
            val factory = SimpleClientHttpRequestFactory().apply {
                setConnectTimeout(connectTimeout)
                setReadTimeout(readTimeout)
            }
            restClient = RestClient.builder()
                .requestFactory(factory)
                .baseUrl(getUserParamValue("baseURI"))
                .build()
            debug = getUserParamValue("debug").toBoolean()
            logger.info("debug = " + debug)
        }
        return true
    }

    // Action 1: GET /posts/{id}
    override fun action1(): Boolean {
        val id: Int = if (debug) 1 else ThreadLocalRandom.current().nextInt(100)+1
        return try {
            val rsp: String? = restClient.get()
                .uri("/posts/${id}")
                .retrieve()
                .body(String::class.java)
            //Postcondition
            (rsp != null && rsp.length > 2)
        } catch (e: RestClientException) {
            false
        }
    }

    // Action 2: GET /comments/{id}
    override fun action2(): Boolean {
        val id: Int = if (debug) 1 else ThreadLocalRandom.current().nextInt(500)+1
        return try {
            val rsp: String? = restClient.get()
                .uri("/comments/${id}")
                .retrieve()
                .body(String::class.java)
            //Postcondition
            (rsp != null && rsp.length > 2)
        } catch (e: RestClientException) {
            false
        }
    }

    // Action 3: GET /todos/{id}
    override fun action3(): Boolean {
        val id: Int = if (debug) 1 else ThreadLocalRandom.current().nextInt(200)+1
        return try {
            val rsp: String? = restClient.get()
                .uri("/todos/${id}")
                .retrieve()
                .body(String::class.java)
            //Postcondition
            (rsp != null && rsp.length > 2)
        } catch (e: RestClientException) {
            false
        }
    }

    // Action 99
    override fun onStop(): Boolean {
        return true
    }

    // RestClient object
    companion object {
        private lateinit var restClient: RestClient
        private var debug: Boolean = false
        private val logger = LoggerFactory.getLogger(HttpUser::class.java)
    }
}
----

=== Run Script

.run_bench.sh
[source,bash,linenums]
----
#!/bin/bash
# jbang io.github.wfouche.tulip:tulip-runtime:2.1.3 Kotlin
rm -f benchmark_report.html
export JBANG_JAVA_OPTIONS="-server -Xms2g -Xmx2g -XX:+UseZGC -XX:+ZGenerational"
jbang run App.kt
echo ""
#w3m -dump -cols 205 benchmark_report.html
lynx -dump -width 205 benchmark_report.html
#jbang run https://gist.github.com/wfouche/70738de122128bbc19ea888799151699 benchmark_config.adoc
----

.run_bench.cmd
[source,bash,linenums]
----
REM jbang io.github.wfouche.tulip:tulip-runtime:2.1.3 Kotlin
if exist benchmark_report.html del benchmark_report.html
set JBANG_JAVA_OPTIONS=-server -Xms2g -Xmx2g -XX:+UseZGC -XX:+ZGenerational
call jbang run App.kt
@echo off
echo.
REM call w3m.exe -dump -cols 205 benchmark_report.html
lynx.exe -dump -width 205 benchmark_report.html
start benchmark_report.html
REM jbang run https://gist.github.com/wfouche/70738de122128bbc19ea888799151699 benchmark_config.adoc
REM start benchmark_config.html
----

=== Benchmark Configuration

.benchmark_config.jsonc
[source,json,linenums]
----
{
    // Actions
    "actions": {
        "description": "Spring RestClient Benchmark [Kotlin]",
        "output_filename": "benchmark_output.json",
        "report_filename": "benchmark_report.html",
        "user_class": "HttpUser",
        "user_params": {
            "baseURI": "https://jsonplaceholder.typicode.com",
            "connectTimeoutMillis": 500,
            "readTimeoutMillis": 2000,
            "debug": false
        },
        "user_actions": {
            "0": "onStart",  // Init
            "1": "GET:posts",
            "2": "GET:comments",
            "3": "GET:todos",
            "99": "onStop"   // Shutdown
        }
    },
    // Workflows using Markov chains
    "workflows": {
        "api-user": {
            "-": {
                "1": 0.40,
                "3": 0.60
            },
            "1": {
                "2": 1.0
            },
            "2": {
                "-": 1.0
            },
            "3": {
                "-": 1.0
            }
        }
    },
    // Benchmarks
    "benchmarks": {
        "onStart": {
            "scenario_actions": [ {"id": 0} ]
        },
         "REST1": {
            "enabled": true,
            "aps_rate": 10.0,
            "scenario_actions": [
                {
                    "id": 1
                }
            ],
            "time": {
                "pre_warmup_duration": 30,
                "warmup_duration": 10,
                "benchmark_duration": 30,
                "benchmark_repeat_count": 3
            }
        },
        "REST2": {
            "enabled": true,
            "aps_rate": 10.0,
            "scenario_actions": [
                {
                    "id": 1, "weight": 10
                },
                {
                    "id": 2, "weight": 40
                },
                {
                    "id": 3, "weight": 50
                }
            ],
            "time": {
                "pre_warmup_duration": 30,
                "warmup_duration": 10,
                "benchmark_duration": 30,
                "benchmark_repeat_count": 3
            }
        },
        "REST3": {
            "enabled": true,
            "aps_rate": 10.0,
            "scenario_workflow": "api-user",
            "time": {
                "pre_warmup_duration": 30,
                "warmup_duration": 10,
                "benchmark_duration": 30,
                "benchmark_repeat_count": 3
            }
        },
        "onStop": {
            "scenario_actions": [
                {
                    "id": 99
                }
            ]
        }
    },
    // Contexts
    "contexts": {
        "Context-1": {
            "enabled": true,
            "num_users": 128,
            "num_threads": 2
        }
    }
}
----

=== Console Output

This is the information that Tulip writes to the console when initializing after method TulipApi.runTulip() was called.

image::images/image-tulip-console-1.png[]

=== Performance Report - Console

image::images/image-tulip-report-1.png[]

=== Performance Report - Browser

image::images/image-tulip-report-2.png[]

== Basic Principles

<Under construction.>

// Links

// https://github.com/errata-ai/vale

// https://redhat-documentation.github.io/vale-at-red-hat/docs/main/user-guide/asciidoc-style-for-vale/

[appendix]
== License

[source,text]
----
Copyright 2024 Werner Fouch√©

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
----